<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="ISO-8859-1" /> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Documents</title>


<script src="https://code.jquery.com/jquery-3.5.1.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">

<!-- jQuery library -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->

<!-- Popper JS -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

<link rel ="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">

<link th:href="@{/css/style.css}" rel="stylesheet" />
<script type="text/javascript">

	$(document).ready(function(){

		var docarr = "";
		
		var lyear,lmonth,ldate,differnce_time,Difference_In_Days;
		var date 	= new Date();
		var tyear 	= (parseInt(date.getFullYear()));
		var tmonth 	= (parseInt(String(date.getMonth()+1).padStart(2,'0')));
		var tdate  	= (parseInt(String(date.getDate()).padStart(2 , '0')));
		var nyear,nmonth,ndate;
	
		$.ajax({
			
			type     : "GET",
		    url      : "viewalldocuments",
			dataType : "json",
			success  : function(result) 
			{	
				var sr=result.length;
				
				for(var i=0;i<result.length;i++)
				{alert(result[i].last_renewed_date);
					const dt = new Date(result[i].last_renewed_date);
					const todaysdate = new Date();
					
					nyear 	=	dt.getFullYear(); //new Date(result[i].last_renewed_date).getFullYear();
					nmonth	=	dt.getMonth()+1;  //new Date(result[i].last_renewed_date).getMonth()+1;
					ndate	=	dt.getDate(); 	  //new Date(result[i].last_renewed_date).getDate();
					
					nmnt = ""+nmonth;
					
					if(nmnt.length==1)
					{
						nmonth = '0'+nmonth;	
					}
									
					var nyeardate = (nyear+(result[i].license_duration))+"-"+nmonth+"-"+ndate;
					
					const diffTime = Math.abs(new Date(nyeardate).getTime() - new Date(todaysdate).getTime());
				
					var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
					
					if(diffDays >=1 && diffDays <=30)
					{
						alert(result[i].doc_name+" needs to be renewed on or before "+nyeardate);
					}
					
					docarr = docarr 
							//+"<tr><td>" + (sr--)  
							//+"<tr><td><a href='viewfile?id="+result[i].doc_id+"'>"+result[i].doc_name+"</a>"
							+"<tr><td><a href='fileexists?id="+result[i].doc_id+"'>"+result[i].doc_name+"</a>"
							+"</td><td>"+result[i].email
							+"</td><td>"+result[i].issued_date
							+"</td><td>"+result[i].last_renewed_date
							+"</td><td id='nrenewdate'>"+(Number(nyear+result[i].license_duration))+"-"+nmonth+"-"+ndate
							
							+"</td><td><a href='getdocbyid?id="+result[i].doc_id+"'><i class='far fa-edit fa-lg'></i>&nbsp;&nbsp;Update</a>&nbsp;&nbsp;<a onclick='deldocbyid("+result[i].doc_id+")'  href><i class='far fa-trash fa-lg'></i>&nbsp;&nbsp;Delete</a></td></tr>";
				}
				
				$(docarr).appendTo("#docbody");
				$('#doctable').DataTable( {
			        "order": [ 5, "asc" ],
			        "fnRowCallback": function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
			        	
			        	var rowCount = $("#doctable tr").length;
						
			        	for(var i=0;i<rowCount;i++){
			        	
			        		var tdata = aData[4];
							const todaysdate = new Date();
							const diffTime = Math.abs(new Date(tdata).getTime() - new Date(todaysdate).getTime());
							const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 	
			        	
							if(diffDays >=1 && diffDays <=30)
					      	{
					    		$('td', nRow).css('color', 'Red');
					      	}
							if(diffDays >=1 )
					      	{
								alert("Diffrence");
					      	}
					    }
							
					}
			    });
			},
			error: function(e)
			{
				alert(JSON.stringify(e));
				console.log(JSON.stringify(e));
			}
		});
	});
	
	
	function deldocbyid(did)
	{
		let res = confirm("Are you sure?");
		if(res)
		{
			$.ajax({
					url 	: '/deldocbyid/'+did,
					type 	: 'GET',
					dataType: 'json',
					success : function(result)
					{
						if(result=="success")
						{
							alert("Document with Id "+did+" is deleted successfully");	
						}
						else{
							alert("Document with Id "+did+" is not deleted ");
						}
					},
					error : function(err)
					{
						alert(""+err);	
					}
			});
		}
		else{
			alert("Document is not deleted");
		}
	}
</script>

</head>
<body>
	<div th:replace="Header.html :: header"></div>
	<div th:replace="Sidebar.html :: sidebar"></div>

	<div class="container">
			<div th:if="${response}"><h6 class="alert alert-success">[[${response}]]</h6></div>
			<div th:if="${reserr}"><h6 class="alert alert-danger">[[${reserr}]]</h6></div>
			<div class="card-header"><h4>View Documents</h4></div>
		<div class="form-group mb-3">
		<table class="table table-striped table-hover" id="doctable">
			<thead>
				<tr>
<!-- 					<td>Sr no.</td> -->
					<td>Document Name</td>
					<td>Email</td>
					<td>Issued Date </td>
					<td>Last Updated Date </td>
					<td>Next Renewal Date </td>
					<td>Actions</td>
				</tr>
			</thead>
			<tbody id="docbody"></tbody>
		</table>	
		</div>
	  </div>

	<div th:replace="Footer.html :: footer"></div>
</body>
</html>
